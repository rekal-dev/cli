# M1: Command Scaffolding, Preconditions & Empty DuckDB Backend

**Goal:** Every command is registered, runs preconditions, and exits cleanly. `init` creates `.rekal/` with empty DuckDB databases. `clean` removes it. All other commands verify preconditions and print "not yet implemented". Basic unit tests for everything.

**Tag:** `v0.0.4`

---

## Deliverables

### 1. Error handling foundation
- [x] `errors.go` — `SilentError` type (follows entire.io pattern)
- [x] `main.go` — Signal handling, `SilentError` dispatch, unknown command suggestions

### 2. Shared preconditions (`preconditions.go`)
- [x] `EnsureGitRoot() (string, error)` — Resolve git root via `git rev-parse --show-toplevel`
- [x] `EnsureInitDone(gitRoot string) error` — Check `.rekal/` exists with `data.db` and `index.db`
- [x] Unit tests: not-a-git-repo, git-repo-no-init, git-repo-with-init

### 3. DuckDB backend (`db/` package)
- [x] `go get github.com/marcboeker/go-duckdb`
- [x] `db.go` — `OpenData(gitRoot)`, `OpenIndex(gitRoot)`, `Close()`
- [x] `schema.go` — DDL for data DB tables (sessions, checkpoints, files_touched, checkpoint_sessions) and index DB tables (turns_ft, tool_calls_index, files_index, session_facets, file_cooccurrence)
- [x] `db_test.go` — Open/close connectivity, verify tables exist after init

### 4. Commands (all registered in root.go)

| Command | M1 Scope | File |
|---------|----------|------|
| `rekal init` | Full: create `.rekal/`, DuckDB databases, `.gitignore` entry, hooks (stub markers), remote branch (stub) | `init.go` |
| `rekal clean` | Full: remove `.rekal/`, remove hook markers | `clean.go` |
| `rekal checkpoint` | Stub: preconditions → "not yet implemented" | `checkpoint.go` |
| `rekal push` | Stub: preconditions → "not yet implemented" | `push.go` |
| `rekal index` | Stub: preconditions → "not yet implemented" | `index_cmd.go` |
| `rekal log` | Stub: preconditions + `--limit` flag → "not yet implemented" | `log.go` |
| `rekal query` | Stub: preconditions + `--index` flag + sql arg → "not yet implemented" | `query.go` |
| `rekal sync` | Stub: preconditions → "not yet implemented" | `sync.go` |
| `rekal` (recall) | Stub: preconditions + filter flags → "not yet implemented" | root.go RunE |

### 5. Unit tests for every command
- Each command file has `*_test.go` verifying:
  - Precondition errors (not a git repo, not initialized)
  - Happy path (for init/clean: directory created/removed; for stubs: "not yet implemented" output)
- Use `t.Parallel()` everywhere
- Use temp directories with `git init` for test repos

### 6. CLAUDE.md
- [x] Created with architecture, patterns, dev workflow

---

## What M1 does NOT include

- No session extraction (checkpoint is a stub)
- No binary encoding (push is a stub)
- No fulltext/vector indexing (index is a stub)
- No remote branch creation (init creates `.rekal/` and DBs only; remote is a stub message)
- No git hooks that actually call rekal (hooks are stubs with markers)
- No recall/search implementation
- No sync implementation

---

## Verification

```bash
# Build
mise run build

# In a git repo:
./rekal init           # Creates .rekal/ with data.db and index.db
./rekal log            # "Not yet implemented"
./rekal checkpoint     # "Not yet implemented"
./rekal clean          # Removes .rekal/

# Outside a git repo:
./rekal init           # "Not a git repository."

# Tests pass:
mise run test:ci
mise run lint
```

---

## Release

After all tests pass:
```bash
git tag v0.0.4
git push origin v0.0.4
```
